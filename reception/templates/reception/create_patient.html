{% extends 'base.html' %}
{% load static %}
{% load jformat %}

{% block title %}ثبت بیمار جدید{% endblock %}

{% block extra_head %}
<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<!-- Persian Date core library -->
<script src="https://unpkg.com/persian-date@latest/dist/persian-date.min.js"></script>

<!-- Persian Date CSS -->
<link rel="stylesheet" href="https://unpkg.com/persian-datepicker@latest/dist/css/persian-datepicker.min.css">

<!-- Select2 CSS -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/@ttskch/select2-bootstrap4-theme@1.5.1/dist/select2-bootstrap4.min.css" rel="stylesheet" />

<style>
    .create-patient-card {
        background: var(--card-light);
        border-radius: 24px;
        box-shadow: 0 20px 50px rgba(0, 0, 0, 0.12);
        overflow: hidden;
        max-width: 1100px;
        margin: 0 auto;
    }

    .card-header-custom {
        background: linear-gradient(135deg, var(--primary), var(--secondary));
        color: #3d8bfd;
        padding: 3rem 2rem;
        text-align: center;
    }

    .card-header-custom h2 {
        font-weight: 300;
        font-size: 2.3rem;
    }

    .required-label::after {
        content: " *";
        color: #dc3545;
        font-weight: bold;
    }

    .form-control, .form-select, .select2-container .select2-selection {
        border-radius: 14px;
        padding: 0.9rem 1.3rem;
        font-size: 1.05rem;
    }

    .select2-container--bootstrap4 .select2-selection--multiple {
        /* min-height: 56px !important; */
        /* padding: 0.5rem 1rem; */
        border-radius: 16px !important;
        border: 2px solid #e0e0e0;  
        background-color: white;

    }
    .select2-search__field{
        line-height: 0.7;
    }

    .select2-container .select2-selection--single {
        height: 50px !important;
        padding: 0.5rem 1rem;
    }

    .patient-photo-preview {
        width: 150px;
        height: 150px;
        object-fit: cover;
        border-radius: 20px;
        border: 4px solid var(--primary);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    }

    .upload-section {
        background: #f8f9fa;
        border: 2px dashed #ced4da;
        border-radius: 16px;
        padding: 2rem;
        text-align: center;
        transition: all 0.3s ease;
    }

    .upload-section:hover {
        border-color: var(--primary);
        background: #e8f4ff;
    }

    .uploaded-file {
        background: white;
        border-radius: 12px;
        padding: 0.8rem 1.2rem;
        margin: 0.5rem 0;
        box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .submit-btn {
        border-radius: 16px;
        padding: 1.2rem 2rem;
        font-size: 1.1rem;
        font-weight: 600;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        transition: all 0.3s ease;
    }

    .submit-btn:hover {
        transform: translateY(-4px);
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.25);
    }

    .form-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 1.8rem;
    }

    @media (max-width: 768px) {
        .form-grid {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row justify-content-center">
        <div class="col-12">
            <div class="create-patient-card">
                <div class="card-header-custom">
                    <h2><i class="fas fa-user-plus me-3"></i> ثبت بیمار جدید</h2>
                    <p class="mb-0 opacity-90">تمام فیلدهای ستاره‌دار اجباری هستند</p>
                </div>

                <div class="card-body p-5">
                    {% if messages %}
                        {% for message in messages %}
                        <div class="alert {% if message.tags == 'error' %}alert-danger{% else %}alert-success{% endif %} alert-dismissible fade show mb-4">
                            {{ message }}
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                        {% endfor %}
                    {% endif %}

                    <form method="post" enctype="multipart/form-data" id="patient-form">
                        {% csrf_token %}

                        <div class="text-center mb-5">
                            <img src="{% static 'images/avatar.png' %}" alt="عکس بیمار" class="patient-photo-preview" id="photo-preview">
                            <div class="mt-3">
                                <label class="btn btn-outline-primary btn-lg">
                                    <i class="fas fa-camera me-2"></i> انتخاب عکس بیمار
                                    <input type="file" name="photo" accept="image/*" id="photo-input" style="display: none;">
                                </label>
                            </div>
                        </div>

                        <div class="form-grid mb-4">
                            <!-- شماره پرونده -->
                            <div>
                                <label class="form-label fw-bold required-label">شماره پرونده</label>
                                <input type="text" name="case_number" class="form-control form-control-lg auto-filled" 
                                       value="{{ suggested_case_number }}" required id="id_case_number">
                                <small class="text-muted">پیشنهادی سیستم. قابل ویرایش (باید منحصر به فرد باشد)</small>
                            </div>

                            <!-- نام و نام خانوادگی -->
                            <div>
                                <label class="form-label fw-bold required-label">نام و نام خانوادگی</label>
                                <input type="text" name="full_name" class="form-control form-control-lg" required>
                            </div>

                            <!-- تلفن همراه اصلی -->
                            <div>
                                <label class="form-label fw-bold required-label">تلفن همراه اصلی</label>
                                <input type="text" name="phone" class="form-control form-control-lg" dir="ltr" required>
                            </div>

                            <!-- تلفن همراه دوم -->
                            <div>
                                <label class="form-label fw-bold">تلفن همراه دوم</label>
                                <input type="text" name="alternative_phone" class="form-control form-control-lg" dir="ltr">
                            </div>

                            <!-- کد ملی -->
                            <div>
                                <label class="form-label fw-bold">کد ملی</label>
                                <input type="text" name="national_id" class="form-control form-control-lg" dir="ltr" maxlength="10">
                            </div>

                            <!-- تاریخ تولد شمسی -->
                            <!-- فقط فیلد تاریخ تولد را اینطور بگذار: -->
                            <div>
                                <label class="form-label fw-bold required-label">تاریخ تولد (شمسی)</label>
                                <input 
                                    type="text" 
                                    name="birth_date" 
                                    class="form-control form-control-lg" 
                                    id="birth-date" 
                                    placeholder="انتخاب یا وارد کردن تاریخ" 
                                    required
                                    
                                >
                                <small class="text-muted">تقویم جلالی با اعداد فارسی</small>
                            </div>

                            <!-- سن -->
                            <div>
                                <label class="form-label fw-bold">سن (سال)</label>
                                <input 
                                    type="number" 
                                    name="age" 
                                    class="form-control form-control-lg" 
                                    id="age-output" 
                                    readonly 
                                    placeholder="محاسبه خودکار"
                                >
                            </div>

                            <!-- جنسیت -->
                            <div>
                                <label class="form-label fw-bold required-label ">جنسیت</label>
                                <select name="gender" class="form-select form-select-lg" id="gender" required>
                                    <option value="">&nbsp&nbsp&nbsp&nbspانتخاب کنید </option>
                                    <option value="male">&nbsp&nbsp&nbsp&nbspمرد</option>
                                    <option value="female">&nbsp&nbsp&nbsp&nbspزن</option>
                                </select>
                            </div>

                            <!-- سایز پا -->
                            <div>
                                <label class="form-label fw-bold">سایز پا</label>
                                <input type="text" name="foot_size" class="form-control form-control-lg" placeholder="مثال: 42">
                            </div>

                            <!-- معرف -->
                            <div>
                                <label class="form-label fw-bold">معرف</label>
                                <select name="referrer" class="form-select form-select-lg select2-allow-new">
                                    <option value="">انتخاب یا وارد کنید</option>
                                    {% for r in referrers %}
                                    <option value="{{ r }}">{{ r }}</option>
                                    {% endfor %}
                                </select>
                            </div>

                            <!-- پیوست به بیمار دیگر -->
                            <div>
                                <label class="form-label fw-bold">پیوست به بیمار دیگر (اختیاری)</label>
                                <select name="attached_to" class="form-select form-select-lg select2-ajax" id="attached-patient">
                                    <option value="">جستجو بر اساس نام یا شماره پرونده...</option>
                                </select>
                            </div>
                        </div>

                        <!-- علت مراجعه -->
                        <div class="mb-4">
                            <label class="form-label fw-bold required-label">علت مراجعه</label>
                            <textarea name="visit_reason" class="form-control" rows="1" required></textarea>
                        </div>

                        <!-- بیماری‌های زمینه‌ای -->
                        <div class="mb-4">
                            <label class="form-label fw-bold">بیماری‌های زمینه‌ای</label>
                            <select name="underlying_diseases" class="form-select select2-multi" id="diseases" multiple>
                                {% for d in underlying_diseases %}
                                <option value="{{ d }}">{{ d }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <!-- سوابق ارتوتیک -->
                        <div class="mb-4">
                            <label class="form-label fw-bold">سوابق استفاده از ارتوتیک</label>
                            <select name="orthotic_history" class="form-select select2-multi" id="orthotic_history" multiple>
                                {% for h in orthotic_histories %}
                                <option value="{{ h }}">{{ h }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <!-- آدرس مختصر -->
                        <div class="mb-4">
                            <label class="form-label fw-bold">آدرس مختصر</label>
                            <input type="text" name="short_address" class="form-control form-control-lg">
                        </div>

                        <!-- یادداشت پذیرش -->
                        <div class="mb-5">
                            <label class="form-label fw-bold">یادداشت پذیرش</label>
                            <textarea name="reception_notes" class="form-control" rows="2"></textarea>
                        </div>

                        <!-- بارگذاری مدارک -->
                        <div class="mb-5">
                            <label class="form-label fw-bold">بارگذاری مدارک</label>
                            <div class="upload-section">
                                <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                                <p class="text-muted">فایل‌ها را اینجا بکشید یا کلیک کنید</p>
                                <input type="file" name="documents" multiple class="form-control form-control-lg" id="documents-input">
                            </div>
                            <div id="uploaded-files-list" class="mt-3"></div>
                        </div>

                        <div class="d-flex flex-wrap gap-3 justify-content-center no-print">
                            <button type="submit" name="action" value="save_print" class="btn btn-info text-white submit-btn">
                                <i class="fas fa-print me-2"></i> ذخیره و چاپ
                            </button>
                            <button type="submit" name="action" value="save_return" class="btn btn-success submit-btn">
                                <i class="fas fa-save me-2"></i> ذخیره و بازگشت
                            </button>
                            <button type="reset" class="btn btn-outline-warning submit-btn">
                                <i class="fas fa-undo me-2"></i> بازنشانی
                            </button>
                            <a href="{% url 'reception:dashboard' %}" class="btn btn-outline-secondary submit-btn">
                                <i class="fas fa-arrow-left me-2"></i> انصراف
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/persian-datepicker@latest/dist/js/persian-datepicker.min.js"></script>

<!-- Select2 JS -->
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
$(document).ready(function() {
    // پیش‌نمایش عکس بیمار
    $('#photo-input').on('change', function(e) {
        if (e.target.files && e.target.files[0]) {
            $('#photo-preview').attr('src', URL.createObjectURL(e.target.files[0]));
        }
    });
    $('#photo-input').on('change', function(e) {
        if (e.target.files && e.target.files[0]) {
            $('#photo-preview').attr('src', URL.createObjectURL(e.target.files[0]));
        }
    });
    $('#gender').on('change', function(e) {
        const fileSelected = $('#photo-input').get(0).files.length > 0;
        if (fileSelected) return; // اگر کاربر عکس دلخواه انتخاب کرده، آن را تغییر نده
        const val = $(this).val();
        if (val === 'male') {
            $('#photo-preview').attr('src', "{% static 'images/man.png' %}");
        } else if (val === 'female') {
            $('#photo-preview').attr('src', "{% static 'images/woman.png' %}");
        } else {
            $('#photo-preview').attr('src', "{% static 'images/avatar.png' %}");
        }
    });
    // نمایش فایل‌های آپلود شده
    $('#documents-input').on('change', function(e) {
        const files = e.target.files;
        const list = $('#uploaded-files-list');
        list.empty();
        for (let file of files) {
            list.append(`
                <div class="uploaded-file">
                    <span><i class="fas fa-file-alt me-2"></i>${file.name}</span>
                    <small class="text-muted">${(file.size / 1024).toFixed(1)} KB</small>
                </div>
            `);
        }
    });
const underlyingConditions = [
    { id: 'Diabetes-Mellitus', text: 'دیابت' },
    { id: 'Hypertension', text: 'فشار خون بالا' },
    { id: 'Cardiovascular-Disease', text: 'بیماری‌های قلبی عروقی' },
    { id: 'Rheumatoid-Arthritis', text: 'آرتریت روماتوئید' },
    { id: 'Osteoarthritis', text: 'آرتروز (ساییدگی مفصل)' },
    { id: 'Thyroid-Disorders', text: 'اختلالات تیروئید' },
    { id: 'Osteoporosis', text: 'پوکی استخوان' },
    { id: 'Peripheral-Neuropathy', text: 'نوروپاتی محیطی (آسیب عصبی)' },
    { id: 'Multiple-Sclerosis', text: 'ام‌اس (MS)' },
    { id: 'Parkinsons-Disease', text: 'بیماری پارکینسون' },
    { id: 'Chronic-Kidney-Disease', text: 'بیماری مزمن کلیه' },
    { id: 'Liver-Disease', text: 'بیماری مزمن کبد' },
    { id: 'Autoimmune-Disease', text: 'بیماری‌های خودایمنی' },
    { id: 'Gout', text: 'نقرس' },
    { id: 'Anemia', text: 'کم‌خونی' },
    { id: 'Obesity', text: 'چاقی' },
    { id: 'Vitamin-D-Deficiency', text: 'کمبود ویتامین D' },
    { id: 'History-of-Stroke', text: 'سابقه سکته مغزی' },
];


    // بیماری زمینه ای
    $('#diseases').select2({
       tags: true, tokenSeparators: [',', ' '], placeholder: 'انتخاب یا اضافه کن', data: underlyingConditions
    });

const footOrthosisHistory = [
    { id: 'No Orthosis Use', text: 'تا کنون از ارتوز پا استفاده نکرده‌ام' },
    { id: 'Custom-Foot-Orthosis', text: 'ارتوز اختصاصی (سفارشی‌سازی‌شده)' },
    { id: 'Prefabricated-Orthosis', text: 'ارتوز آماده (بازاری)' },
    { id: 'Medical-Insole', text: 'کفی طبی' },
    { id: 'Sport-Insole', text: 'کفی ورزشی' },
    { id: 'Diabetic-Insole', text: 'کفی مخصوص پای دیابتی' },
    { id: 'Pediatric-Orthosis', text: 'ارتوز پای کودکان' },
    { id: 'Ankle-Foot-Orthosis', text: 'ارتوز مچ و پا (AFO)' },
    { id: 'Night-Splint', text: 'اسپلینت شبانه پا' },
    { id: 'Post-Surgical-Orthosis', text: 'ارتوز پس از جراحی پا' },
    { id: 'Temporary-Orthosis', text: 'ارتوز موقت / کوتاه‌مدت' },
    { id: 'Discontinued-Orthosis', text: 'قبلاً استفاده کرده‌ام ولی ادامه نداده‌ام' },
];

        // سابقه ارتوتیک
    $('#orthotic_history').select2({
    tags: true, tokenSeparators: [',', ' '], placeholder: 'انتخاب یا اضافه کن', data: footOrthosisHistory
    });

    // معرف با افزودن جدید
    $('.select2-allow-new').select2({
        theme: 'bootstrap4',
        tags: true,
        placeholder: "انتخاب یا وارد کنید"
    });

    // جستجوی زنده پیوست بیمار
    $('#attached-patient').select2({
        theme: 'bootstrap4',
        placeholder: "جستجو بر اساس نام یا شماره پرونده...",
        ajax: {
            url: '{% url 'reception:search-patients-ajax' %}',
            dataType: 'json',
            delay: 300,
            data: function(params) {
                return { q: params.term };
            },
            processResults: function(data) {
                return {
                    results: data.map(function(p) {
                        return { id: p.id, text: p.full_name + ' (' + p.case_number + ')' };
                    })
                };
            }
        }
    });
// تابع محاسبه سن از تاریخ شمسی (فرمت YYYY/MM/DD یا YYYY/M/D)
    function calculateAgeFromString(dateStr) {
        if (!dateStr || dateStr.trim() === '') {
            $('#age-output').val('');
            return;
        }

        // پاک کردن اسلش‌های اضافی و استانداردسازی
        const cleanDate = dateStr.trim().replace(/\//g, '/');
        const parts = cleanDate.split('/');
        if (parts.length !== 3) {
            $('#age-output').val('');
            return;
        }

        let jYear = parseInt(parts[0]);
        let jMonth = parseInt(parts[1]);
        let jDay = parseInt(parts[2]);

        if (isNaN(jYear) || isNaN(jMonth) || isNaN(jDay)) {
            $('#age-output').val('');
            return;
        }

        // اگر ماه یا روز تک رقمی بود، درستش کن
        if (jMonth < 1 || jMonth > 12 || jDay < 1 || jDay > 31) {
            $('#age-output').val('');
            return;
        }

        const today = new persianDate();
        let age = today.year() - jYear;

        if (today.month() < jMonth || (today.month() === jMonth && today.date() < jDay)) {
            age--;
        }

        $('#age-output').val(age >= 0 ? age : 0);
    }

    // فعال‌سازی تقویم جلالی
    $("#birth-date").persianDatepicker({
        format: 'YYYY/MM/DD',
        autoClose: true,
        initialValue: false,
        persianDigit: true,
        calendar: {
            persian: {
                locale: 'fa',
                showHint: true,
                leapYearMode: 'astronomical'
            }
        },
        navigator: {
            enabled: true,
        },
        toolbox: {
            enabled: true,
            calendarSwitch: {
                enabled: true
            }
        },
        observer: true,
        altField: '#birth-date',
        altFormat: 'YYYY/MM/DD',
        onSelect: function(unix) {
            // وقتی از تقویم انتخاب شد
            const selected = new persianDate(unix);
            const formatted = selected.format('YYYY/MM/DD');
            $('#birth-date').val(formatted);
            calculateAgeFromString(formatted);
        }
    });

    // وقتی کاربر دستی تایپ کرد و از فیلد خارج شد (blur)
    $('#birth-date').on('blur', function() {
        const value = $(this).val();
        calculateAgeFromString(value);
    });

    // اگر کاربر بخشی از تاریخ رو پاک کرد
    $('#birth-date').on('input', function() {
        if ($(this).val().trim() === '') {
            $('#age-output').val('');
        }
    });
});
</script>
{% endblock %}